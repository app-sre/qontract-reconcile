---
# Source: qontract-reconcile/templates/template.yaml
apiVersion: v1
kind: Template
metadata:
  name: qontract-reconcile
objects:
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-aws-garbage-collector
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: aws-garbage-collector
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} aws-garbage-collector ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 50m
              memory: 400Mi
            requests:
              cpu: 25m
              memory: 200Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-aws-iam-keys
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: aws-iam-keys
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} aws-iam-keys ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 25m
              memory: 200Mi
            requests:
              cpu: 15m
              memory: 100Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-github
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: github
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} github ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 25m
              memory: 80Mi
            requests:
              cpu: 15m
              memory: 50Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-github-repo-invites
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: github-repo-invites
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} github-repo-invites ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 25m
              memory: 55Mi
            requests:
              cpu: 15m
              memory: 30Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-quay-membership
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: quay-membership
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} quay-membership ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 25m
              memory: 60Mi
            requests:
              cpu: 15m
              memory: 30Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-quay-repos
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: quay-repos
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} quay-repos ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 25m
              memory: 60Mi
            requests:
              cpu: 15m
              memory: 30Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-jira-watcher
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: jira-watcher
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} jira-watcher --io-dir /tmp/throughput/; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 25m
              memory: 200Mi
            requests:
              cpu: 15m
              memory: 80Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-github-scanner
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: github-scanner
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} github-scanner --thread-pool-size 1; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          env:
          - name: gitlab_pr_submitter_queue_url
            valueFrom:
              secretKeyRef:
                name: ${APP_INTERFACE_SQS_SECRET_NAME}
                key: gitlab_pr_submitter_queue_url
          resources:
            limits:
              cpu: 400m
              memory: 1000Mi
            requests:
              cpu: 200m
              memory: 500Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-aws-support-cases-sos
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: aws-support-cases-sos
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} aws-support-cases-sos ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          env:
          - name: gitlab_pr_submitter_queue_url
            valueFrom:
              secretKeyRef:
                name: ${APP_INTERFACE_SQS_SECRET_NAME}
                key: gitlab_pr_submitter_queue_url
          resources:
            limits:
              cpu: 50m
              memory: 200Mi
            requests:
              cpu: 25m
              memory: 100Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-openshift-users
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: openshift-users
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} openshift-users ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 50m
              memory: 400Mi
            requests:
              cpu: 25m
              memory: 200Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-openshift-groups
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: openshift-groups
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} openshift-groups ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 200m
              memory: 800Mi
            requests:
              cpu: 100m
              memory: 400Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-openshift-namespaces
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: openshift-namespaces
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} openshift-namespaces ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 200m
              memory: 800Mi
            requests:
              cpu: 100m
              memory: 400Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-openshift-rolebindings
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: openshift-rolebindings
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} openshift-rolebindings ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 200m
              memory: 800Mi
            requests:
              cpu: 100m
              memory: 400Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-openshift-network-policies
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: openshift-network-policies
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} openshift-network-policies ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 200m
              memory: 800Mi
            requests:
              cpu: 100m
              memory: 400Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-openshift-acme
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: openshift-acme
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} openshift-acme ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 200m
              memory: 800Mi
            requests:
              cpu: 100m
              memory: 400Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-openshift-limitranges
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: openshift-limitranges
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} openshift-limitranges ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 200m
              memory: 800Mi
            requests:
              cpu: 100m
              memory: 400Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-openshift-resources
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: openshift-resources
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} openshift-resources --external; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 200m
              memory: 800Mi
            requests:
              cpu: 100m
              memory: 400Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-terraform-resources
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: terraform-resources
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} terraform-resources --external; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 200m
              memory: 800Mi
            requests:
              cpu: 100m
              memory: 400Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-terraform-users
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: ${{USER_ID}}
        containers:
        - name: terraform-users
          image: ${IMAGE}:${IMAGE_TAG}
          command:
          - /bin/sh
          - -c
          - while true; do qontract-reconcile --config /config/config.toml ${DRY_RUN} terraform-users ; STATUS=$?; [ "$STATUS" != "0" ] && exit $STATUS; sleep ${SLEEP_DURATION_SECS}; done
          resources:
            limits:
              cpu: 200m
              memory: 800Mi
            requests:
              cpu: 100m
              memory: 400Mi
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
parameters:
- name: IMAGE
  value: quay.io/app-sre/qontract-reconcile
- name: IMAGE_TAG
  value: latest
- name: DRY_RUN
  value: --dry-run
- name: SLEEP_DURATION_SECS
  value: "300"
- name: APP_INTERFACE_SQS_SECRET_NAME
  value: app-interface-sqs
- name: USER_ID
  value: "1031160000"
