# Secret Management with Vault

`qontract-reconcile` uses HashiCorp Vault as its central secret management system. A standardized pattern, enforced through GraphQL schemas and utility functions, ensures that secrets are handled securely and consistently across all integrations.

This pattern keeps credentials out of the codebase and provides a single, auditable path for secret access.

## The Secret Management Workflow

The process involves defining, referencing, and reading secrets.

**1. Define a Secret in `app-interface`**

All secrets must first be stored in Vault. Then, a reference to that secret is created in `app-interface` using a `VaultSecret_v1` YAML structure. This reference does not contain the secret itself, only its location in Vault.

*Example: A token for `my-api`*
```yaml
# in some-app.yml in app-interface
...
  my_api_token:
    path: /path/to/my/secret
    field: api_key
    version: 1
    format: plain
...
```

**2. Reference the Secret in a GraphQL Query**

When an integration needs this secret, it references it in its `.gql` query, typically using a shared fragment named `VaultSecret`.

*Example: `my-integration.gql`*
```graphql
# qenerate: plugin=pydantic_v1

query MyIntegrationData {
  my_config: my_configs_v1 {
    api_token {
      ...VaultSecret
    }
  }
}

fragment VaultSecret on VaultSecret_v1 {
  path
  field
  version
  format
}
```
When `make qenerate` is run, this will generate a Pydantic model that includes a `VaultSecretV1` object for the `api_token` field. This process is described in more detail in the [GraphQL Data Binding documentation](./gql-data-binding.md).

**3. Read the Secret in an Integration**

Inside the integration's Python code, the `SecretReader` utility is used to fetch the secret's value from Vault. The Pydantic model generated by `qenerate` is passed directly to the secret reader.

*Example: `my_integration.py`*
```python
from reconcile.utils.secret_reader import SecretReader

# In the run method:
# ... fetch my_config using the generated query function ...

secret_reader = SecretReader(settings=settings)
for config in my_configs:
    # The 'config.api_token' is a Pydantic object from qenerate
    token = secret_reader.read(config.api_token)

    # Now use the token to authenticate with the API
    api_client = MyApiClient(token=token)
    # ...
```

The `SecretReader` handles all the logic of authenticating with Vault and retrieving the secret based on the path, field, and version defined in `app-interface`. This provides a simple, secure, and highly standardized way for integrations to consume credentials.
