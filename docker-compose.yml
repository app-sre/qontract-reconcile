---
version: "3.9"
services:
  qontract-reconcile:
    stdin_open: true
    tty: true
    build: 
      context: .
      dockerfile: ./dockerfiles/Dockerfile.dev
    environment:
      - INTEGRATION_NAME=${INTEGRATION_NAME}
      - INTEGRATION_EXTRA_ARGS=${INTEGRATION_EXTRA_ARGS}
      - DRY_RUN=${DRY_RUN}
      - SLEEP_DURATION_SECS=${SLEEP_DURATION_SECS}
      - DEBUGGER=${DEBUGGER}
      - CONFIG=/work/config.dev.toml
    volumes:
      - .:/work
    links:
      - qontract-server
      - vault
    ports:
      - 9090:9090  # Metrics Exporter
      - 5678:5678  # Debugger Port
  
  qontract-server:
    build:
      context: ${QONTRACT_SERVER_PATH}
    volumes:
      - ${QONTRACT_SERVER_PATH}/bundle:/bundle:ro
    environment:
      - LOAD_METHOD=fs
      - DATAFILES_FILE=/bundle/bundle.json
    ports:
      - 4000:4000

  vault:
    container_name: vault
    image: "vault:1.5.4"
    environment:
      - VAULT_ADDR=http://127.0.0.1:8200
      - VAULT_TOKEN=root
      - VAULT_DEV_ROOT_TOKEN_ID=root
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    ports:
      - 8200:8200
