---
apiVersion: v1
kind: Template
metadata:
  name: qontract-reconcile
objects:
{{- range $i, $integration := .Values.integrations }}
- apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    labels:
      app: qontract-reconcile
    name: qontract-reconcile-{{ $integration.name }}
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: qontract-reconcile
    template:
      metadata:
        labels:
          app: qontract-reconcile
      spec:
        securityContext:
          runAsUser: {{ "${{USER_ID}}" }}
        containers:
        - name: {{ $integration.name }}
          image: ${IMAGE}:${IMAGE_TAG}
          env:
          - name: DRY_RUN
            value: ${DRY_RUN}
          - name: INTEGRATION_NAME
            value: {{ $integration.name }}
          - name: INTEGRATION_EXTRA_ARGS
            value: "{{ $integration.extraArgs }}"
          - name: SLEEP_DURATION_SECS
            value: ${SLEEP_DURATION_SECS}
          - name: LOG_FILE
            value: "${LOG_FILE}"
          {{- with $integration.extraEnv }}
          {{- range $i, $env := . }}
          - name: {{ $env.secretKey }}
            valueFrom:
              secretKeyRef:
                name: {{ $env.secretName }}
                key: {{ $env.secretKey }}
          {{- end }}
          {{- end }}
          resources:
{{ toYaml $integration.resources | indent 12 }}
          volumeMounts:
          - name: qontract-reconcile-toml
            mountPath: /config
        volumes:
        - name: qontract-reconcile-toml
          secret:
            secretName: qontract-reconcile-toml
{{- end }}
parameters:
- name: IMAGE
  value: quay.io/app-sre/qontract-reconcile
- name: IMAGE_TAG
  value: latest
- name: DRY_RUN
  value: --dry-run
- name: SLEEP_DURATION_SECS
  value: "300"
- name: APP_INTERFACE_SQS_SECRET_NAME
  value: app-interface-sqs
- name: USER_ID
  value: "1000720000"
- name: LOG_FILE
  value: ""
